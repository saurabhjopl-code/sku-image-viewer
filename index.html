<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>SKU Image Finder</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 16px;
      background: #f7f7f7;
    }
    .container {
      max-width: 700px;
      margin: 0 auto;
      background: #fff;
      padding: 16px;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }
    h2 {
      margin-top: 0;
      text-align: center;
    }
    .input-wrapper {
      position: relative;
    }
    input, button {
      width: 100%;
      padding: 10px;
      font-size: 16px;
      margin-top: 8px;
      box-sizing: border-box;
      border-radius: 4px;
      border: 1px solid #ccc;
    }
    button {
      border: none;
      background: #007bff;
      color: white;
      font-weight: bold;
      cursor: pointer;
    }
    button:active {
      opacity: 0.85;
    }
    .message {
      margin-top: 12px;
      font-size: 14px;
      color: #555;
      min-height: 18px;
    }

    /* ðŸ”½ Auto-suggest dropdown */
    .suggestions {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: #fff;
      border: 1px solid #ccc;
      border-top: none;
      border-radius: 0 0 4px 4px;
      max-height: 200px;
      overflow-y: auto;
      z-index: 10;
      display: none;
    }
    .suggestion-item {
      padding: 6px 10px;
      font-size: 14px;
      cursor: pointer;
      border-bottom: 1px solid #f0f0f0;
    }
    .suggestion-item:last-child {
      border-bottom: none;
    }
    .suggestion-item:hover {
      background: #f5f5f5;
    }
    .suggestion-item small {
      display: block;
      color: #888;
      font-size: 11px;
    }

    /* ðŸ”½ Results grid: 1 col (mobile), 2 cols (tablet), 3 cols (desktop) */
    .results {
      margin-top: 16px;
      display: grid;
      grid-template-columns: 1fr;
      gap: 12px;
    }
    @media (min-width: 480px) {
      .results {
        grid-template-columns: repeat(2, 1fr);
      }
    }
    @media (min-width: 900px) {
      .results {
        grid-template-columns: repeat(3, 1fr);
      }
    }

    .card {
      border: 1px solid #ddd;
      border-radius: 6px;
      padding: 8px;
      background: #fafafa;
    }
    .card-title {
      font-size: 14px;
      font-weight: bold;
    }
    .card-sku {
      font-size: 12px;
      color: #666;
      margin-top: 2px;
    }
    .card img {
      width: 100%;
      height: auto;
      border-radius: 4px;
      border: 1px solid #eee;
      margin-top: 6px;
      display: none; /* shown when loaded */
    }
    .card-link {
      display: block;
      margin-top: 4px;
      font-size: 11px;
      word-break: break-all;
      color: #007bff;
      text-decoration: none;
    }
    .card-link:hover {
      text-decoration: underline;
    }
    .small-note {
      margin-top: 8px;
      font-size: 11px;
      color: #888;
      text-align: center;
    }

    /* ðŸ”½ Highlight style */
    mark {
      background: #ffeb3b;
      padding: 0 1px;
      border-radius: 2px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>SKU Image Finder</h2>

    <div class="input-wrapper">
      <input
        type="text"
        id="skuInput"
        placeholder="Search by SKU or part of SKU (e.g. 3026, JOPLNB3026A)"
        autocomplete="off"
      >
      <div class="suggestions" id="suggestions"></div>
    </div>

    <button onclick="searchImages()">Search</button>

    <div class="message" id="message">Loading data from sku_images.csv...</div>

    <div class="results" id="results"></div>

    <div class="small-note">
      Data source: <strong>sku_images.csv</strong><br>
      Place this file in the same folder as index.html.
    </div>
  </div>

  <script>
    // Array of { sku, imageLink, title }
    let skuData = [];
    let dataLoaded = false;
    let loadingError = false;

    // Utility: highlight query inside text using <mark>
    function highlightText(text, query) {
      if (!query) return text || "";
      const lowerText = (text || "").toLowerCase();
      const lowerQuery = query.toLowerCase();
      const index = lowerText.indexOf(lowerQuery);
      if (index === -1) return text || "";
      const before = text.slice(0, index);
      const match = text.slice(index, index + query.length);
      const after = text.slice(index + query.length);
      return before + "<mark>" + match + "</mark>" + after;
    }

    // Load CSV file from the same folder as index.html
    async function loadCSV() {
      const msg = document.getElementById("message");

      try {
        const response = await fetch("sku_images.csv");
        if (!response.ok) {
          throw new Error("HTTP " + response.status);
        }

        const text = await response.text();
        const lines = text.trim().split(/[\r\n]+/); // split on new lines

        if (lines.length <= 1) {
          msg.textContent = "CSV file is empty or has only header.";
          loadingError = true;
          return;
        }

        // Header row: SKU,ImageLink,Title
        const header = lines[0].split(",");
        const skuIndex = header.findIndex(h => h.trim().toLowerCase() === "sku");
        const imgIndex = header.findIndex(h => h.trim().toLowerCase() === "imagelink");
        const titleIndex = header.findIndex(h => h.trim().toLowerCase() === "title");

        if (skuIndex === -1 || imgIndex === -1) {
          msg.textContent = "CSV must have 'SKU' and 'ImageLink' columns.";
          loadingError = true;
          return;
        }

        skuData = [];

        // Parse each data row
        for (let i = 1; i < lines.length; i++) {
          const line = lines[i].trim();
          if (!line) continue;

          // Simple CSV: split by comma (avoid commas inside SKU/ImageLink)
          const parts = line.split(",");

          const sku = (parts[skuIndex] || "").trim();
          const imageLink = (parts[imgIndex] || "").trim();
          const title = titleIndex !== -1 ? (parts[titleIndex] || "").trim() : "";

          if (sku && imageLink) {
            skuData.push({ sku, imageLink, title });
          }
        }

        dataLoaded = true;
        msg.textContent = "Data loaded. Start typing to see suggestions, then tap Search.";
      } catch (err) {
        console.error(err);
        msg.textContent = "Failed to load sku_images.csv. Make sure it is in the repo root and public.";
        loadingError = true;
      }
    }

    // Show suggestions while typing
    function updateSuggestions(query) {
      const suggestionsDiv = document.getElementById("suggestions");
      suggestionsDiv.innerHTML = "";

      if (!dataLoaded || !query || query.length < 1) {
        suggestionsDiv.style.display = "none";
        return;
      }

      const lowerQuery = query.toLowerCase();

      // Find up to 10 matching SKUs
      const matches = skuData.filter(item =>
        item.sku.toLowerCase().includes(lowerQuery)
      ).slice(0, 10);

      if (matches.length === 0) {
        suggestionsDiv.style.display = "none";
        return;
      }

      matches.forEach(item => {
        const div = document.createElement("div");
        div.className = "suggestion-item";
        div.innerHTML =
          highlightText(item.sku, query) +
          (item.title ? '<small>' + highlightText(item.title, query) + '</small>' : "");

        div.addEventListener("click", () => {
          const input = document.getElementById("skuInput");
          input.value = item.sku; // fill exact SKU
          suggestionsDiv.style.display = "none";
          searchImages();
        });

        suggestionsDiv.appendChild(div);
      });

      suggestionsDiv.style.display = "block";
    }

    function hideSuggestions() {
      const suggestionsDiv = document.getElementById("suggestions");
      suggestionsDiv.style.display = "none";
    }

    // Search function: finds all SKUs containing the query
    async function searchImages() {
      const input = document.getElementById("skuInput");
      const query = input.value.trim().toLowerCase();
      const msg = document.getElementById("message");
      const resultsDiv = document.getElementById("results");

      hideSuggestions();
      resultsDiv.innerHTML = "";

      if (!query) {
        msg.textContent = "Please type something to search (e.g. 3026).";
        return;
      }

      if (!dataLoaded && !loadingError) {
        msg.textContent = "Loading data from CSV, please wait...";
        await loadCSV();
      }

      if (loadingError) return;

      const matches = skuData.filter(item =>
        item.sku.toLowerCase().includes(query)
      );

      if (matches.length === 0) {
        msg.textContent = "No SKUs found containing: " + query;
        return;
      }

      msg.textContent = "Found " + matches.length + " result(s) for: " + query;

      matches.forEach(item => {
        const card = document.createElement("div");
        card.className = "card";

        const titleEl = document.createElement("div");
        titleEl.className = "card-title";
        titleEl.innerHTML = highlightText(item.title || "(No title)", query);

        const skuEl = document.createElement("div");
        skuEl.className = "card-sku";
        skuEl.innerHTML = "SKU: " + highlightText(item.sku, query);

        const img = document.createElement("img");
        img.src = item.imageLink;
        img.alt = item.sku;
        img.onload = function () {
          img.style.display = "block";
        };
        img.onerror = function () {
          img.style.display = "none";
          const errorMsg = document.createElement("div");
          errorMsg.style.color = "red";
          errorMsg.style.fontSize = "11px";
          errorMsg.textContent = "Image not accessible: " + item.imageLink;
          card.appendChild(errorMsg);
        };

        const link = document.createElement("a");
        link.className = "card-link";
        link.href = item.imageLink;
        link.target = "_blank";
        link.textContent = item.imageLink;

        card.appendChild(titleEl);
        card.appendChild(skuEl);
        card.appendChild(img);
        card.appendChild(link);

        resultsDiv.appendChild(card);
      });
    }

    // Load CSV when page opens
    window.addEventListener("load", loadCSV);

    // Input events
    const skuInput = document.getElementById("skuInput");

    skuInput.addEventListener("keyup", function (e) {
      if (e.key === "Enter") {
        searchImages();
      } else {
        updateSuggestions(skuInput.value);
      }
    });

    // Hide suggestions when clicking outside
    document.addEventListener("click", function (e) {
      const wrapper = document.querySelector(".input-wrapper");
      if (!wrapper.contains(e.target)) {
        hideSuggestions();
      }
    });
  </script>
</body>
</html>
