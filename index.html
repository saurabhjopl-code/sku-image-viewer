<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>SKU Image Finder</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 16px;
      background: #f7f7f7;
    }
    .container {
      max-width: 500px;
      margin: 0 auto;
      background: #fff;
      padding: 16px;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }
    h2 {
      margin-top: 0;
      text-align: center;
    }
    input, button {
      width: 100%;
      padding: 10px;
      font-size: 16px;
      margin-top: 8px;
      box-sizing: border-box;
      border-radius: 4px;
      border: 1px solid #ccc;
    }
    button {
      border: none;
      background: #007bff;
      color: white;
      font-weight: bold;
    }
    button:active {
      opacity: 0.8;
    }
    .message {
      margin-top: 12px;
      font-size: 14px;
      color: #555;
      min-height: 18px;
    }
    img {
      margin-top: 16px;
      max-width: 100%;
      height: auto;
      border: 1px solid #ccc;
      border-radius: 4px;
      display: none;
    }
    a#imgLink {
      display: none;
      margin-top: 8px;
      font-size: 12px;
      word-break: break-all;
    }
    .small-note {
      margin-top: 8px;
      font-size: 11px;
      color: #888;
      text-align: center;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>SKU Image Finder</h2>

    <input type="text" id="skuInput" placeholder="Enter SKU (e.g. JOPLST218)">
    <button onclick="searchImage()">Search</button>

    <div class="message" id="message">Data loading from Excel (CSV)...</div>

    <img id="skuImage" src="" alt="">
    <a id="imgLink" href="#" target="_blank">Open image in new tab</a>

    <div class="small-note">
      Data source: <strong>sku_images.csv</strong><br>
      (Make sure this file is in the same folder as index.html)
    </div>
  </div>

  <script>
    let skuImages = {};       // SKU -> Image URL
    let dataLoaded = false;   // Flag to know when CSV is loaded
    let loadingError = false; // Flag in case CSV load fails

    // Load CSV file and build SKU -> Image map
    async function loadCSV() {
      const msg = document.getElementById("message");

      try {
        const response = await fetch("sku_images.csv");
        if (!response.ok) {
          throw new Error("HTTP " + response.status);
        }

        const text = await response.text();
        const lines = text.trim().split(/[\r\n]+/); // split on new line

        if (lines.length <= 1) {
          msg.textContent = "CSV file is empty or has only header.";
          loadingError = true;
          return;
        }

        // First line is header: SKU,ImageLink,Title
        const header = lines[0].split(",");
        const skuIndex = header.findIndex(h => h.trim().toLowerCase() === "sku");
        const imgIndex = header.findIndex(h => h.trim().toLowerCase().startsWith("imagelink"));

        if (skuIndex === -1 || imgIndex === -1) {
          msg.textContent = "CSV must have 'SKU' and 'ImageLink' columns in header.";
          loadingError = true;
          return;
        }

        // Parse each row
        for (let i = 1; i < lines.length; i++) {
          const line = lines[i].trim();
          if (!line) continue;

          const parts = line.split(",");
          const sku = (parts[skuIndex] || "").trim();
          const imgUrl = (parts[imgIndex] || "").trim();

          if (sku && imgUrl) {
            skuImages[sku] = imgUrl;
          }
        }

        dataLoaded = true;
        msg.textContent = "Data loaded. Enter SKU and tap Search.";
      } catch (err) {
        console.error(err);
        msg.textContent = "Failed to load sku_images.csv. Make sure it is uploaded and accessible.";
        loadingError = true;
      }
    }

    async function searchImage() {
      const input = document.getElementById("skuInput");
      const sku = input.value.trim();
      const img = document.getElementById("skuImage");
      const msg = document.getElementById("message");
      const link = document.getElementById("imgLink");

      if (!sku) {
        msg.textContent = "Please enter a SKU.";
        img.style.display = "none";
        img.src = "";
        link.style.display = "none";
        link.href = "#";
        return;
      }

      if (!dataLoaded && !loadingError) {
        msg.textContent = "Loading data from CSV, please wait a moment...";
        await loadCSV(); // ensure CSV is loaded before searching
      }

      if (loadingError) {
        // If CSV failed to load, don't search
        return;
      }

      // Case-insensitive search
      const key = Object.keys(skuImages).find(
        k => k.toLowerCase() === sku.toLowerCase()
      );

      if (!key) {
        msg.textContent = "No image found for SKU: " + sku;
        img.style.display = "none";
        img.src = "";
        link.style.display = "none";
        link.href = "#";
        return;
      }

      const url = skuImages[key];

      msg.textContent = "Result for: " + key;

      // Show direct image link
      link.style.display = "block";
      link.href = url;
      link.textContent = url;

      img.onload = function () {
        img.style.display = "block";
      };

      img.onerror = function () {
        img.style.display = "none";
        msg.textContent = "Image link is invalid or not accessible: " + url;
      };

      img.src = url;
    }

    // Pre-load CSV when page opens
    window.addEventListener("load", loadCSV);

    // Allow Enter key to trigger search
    document.getElementById("skuInput").addEventListener("keyup", function (e) {
      if (e.key === "Enter") {
        searchImage();
      }
    });
  </script>
</body>
</html>
